---
title: "Kim-User-Clustering"
author: "kimp"
date: "2/23/2019"
output: html_document
---

Load Libraries
```{r}
library(dplyr)
library(tidyr)
library(ggplot2)
```


Import User Activity Data
```{r}
# read original data set
act <- read.csv("/Users/kpham/Desktop/TripAdvisorBrownDatathon/DataFromTripAdvisor/activity_data.csv")
```

Prep data for clustering (one id per row)
```{r}
# count user_action
actClick <- act %>% group_by(user_id, user_action) %>% count()
actClick2 <- spread(actClick, user_action, n, fill=0)
colnames(actClick2) <- c("user_id", "click_booking", "click_hotel_website", "click_price", "click_view")
# check duplicate rows
#actClick[duplicated(actClick$user_id),] 
#actClick2[duplicated(actClick2$user_id),] 

# count hotels viewed
actHotel <- act %>% group_by(hotel_id) %>% count(user_id) %>% select(-n)
actHotel2 <- actHotel %>% group_by(user_id) %>% count()
colnames(actHotel2) <- c("user_id", "hotels_viewed")
# check duplicate rows
# actHotel[duplicated(actHotel$user_id),] 
# actHotel2[duplicated(actHotel2$user_id),] 

# count countries viewed from
actCountry <- act %>% group_by(user_id) %>% count(user_country) %>% select(-n)
actCountry2 <- actCountry %>% group_by(user_id) %>% count()
colnames(actCountry2) <- c("user_id", "countries_viewed_from")
# check duplicate rows
#actCountry[duplicated(actCountry$user_id),] 
#actCountry2[duplicated(actCountry2$user_id),] 

# count devices used
actDevice<- act %>% group_by(user_id) %>% count(device) %>% select(-n)
actDevice2 <- actDevice %>% group_by(user_id) %>% count()
colnames(actDevice2) <- c("user_id", "devices_used")
# check duplicate rows
#actDevice[duplicated(actDevice$user_id),] 
#actDevice2[duplicated(actDevice2$user_id),] 

df <- left_join(actClick2, actHotel2, by="user_id") %>% left_join(actCountry2, by="user_id") %>% left_join(actDevice2, by="user_id")
# check duplicate rows
#df[duplicated(df$user_id),] 
# check for nas
#df[!complete.cases(df),] # none

# I am not using date in my final DF.

# remove user_id
df2<- ungroup(df) %>% select(-user_id)
```

More Pre-Processing Steps - Scale Data
```{r}
df3 <- scale(df2)
```

Scree Plot

```{r}
#Elbow Method for finding the optimal number of clusters
set.seed(123)
# Compute and plot wss for k = 2 to k = 15.
k.max <- 6
data <- df3
wss <- sapply(1:k.max, 
              function(k){kmeans(data, k, nstart=50,iter.max = 15 )$tot.withinss})
wss
plot(1:k.max, wss,
     type="b", pch = 19, frame = FALSE, 
     xlab="Number of clusters K",
     ylab="Total within-clusters sum of squares")
```




```{r}
df.cor <- cor(df3)
round(res, 2)

skc_pca <-prcomp(df.cor)
plot(skc_pca)
print(skc_pca$x[,1:3])
my_cols <- c("#00AFBB", "#E7B800", "#FC4E07")  
pairs(skc_pca$x[,1:3], lower.panel = NULL)


df.m <- as.matrix(df3)
rownames(df.m) <- df$user_id
```


K-Means
```{r}
fit <- kmeans(df3, 4) 
```

Prep Data for Visualization
```{r}
df4 <- data.frame(df2, fit$cluster, df$user_id)
df4$total_clicks <- df4$click_booking + df4$click_hotel_website + df4$click_price + df4$click_view
# df4[!complete.cases(df4),]
df5 <- gather(df4, "click_type", "click_count", 1:4)
```

Visualize Clusters by Total Clicks
```{r}
ggplot(df5, aes(total_clicks, click_count, fill = as.factor(click_type))) + geom_bar(stat="identity") + facet_grid(.~fit.cluster)
```




```{r}
hot <- read.csv("/Users/kpham/Desktop/TripAdvisorBrownDatathon/DataFromTripAdvisor/hotel_data.csv")
# join data user activity and hotel data by hotel_id
df <- left_join(act,hot,by="hotel_id")
# colnames(df)
# head(df)
```








```{r}
# there are 12 hotel_types
# the hotel_type "hotels" have the highest total web activity (1461090)
# the hotel_type "cottage" has the lowest total web activity (2)
# the mean web activity per hotel type (87617.4)
df %>% group_by(hotel_type) %>% count() %>% arrange(desc(n))
df %>% group_by(hotel_type) %>% count() %>% arrange(n) %>% summary()
df %>% group_by(hotel_type) %>% count() %>% summary()

# (total web activity on small hotels: 8428)
# df %>% filter(hotel_type=="Small Hotel") %>% count() 

# filter for only hotel_type == "Hotel"
# levels(df$hotel_type)
df_hotel <- filter(df, hotel_type == "Hotel") %>% droplevels()
colnames(df_hotel)
head(df_hotel)
levels(df_hotel$hotel_type)

```

```{r}
top_hot <- df %>% group_by(hotel_id,user_action) %>% count() 
summary(top_hot$n)
mean(top_hot$n)

(ggplot(data=top_hot, aes(x=as.factor(hotel_id), y=n, fill=user_action)) + geom_bar(stat="identity"))
```



-----


GOALS:
1. Come up with suggestion on how TA can make money

QUESTION:
What hotels should be recommend to what type of users?

SOLUTION:
1. Identify types of users 
2. Identify types of hotels
3. Build item-based recommender system, based on collaborative filtering


```{r}

```





